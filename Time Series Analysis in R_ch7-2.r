
# 7.2 회귀모형 평활법의 분석사례 - 2

# 4) (Kernel Smooth) 평활법 분석사례:  ksmooth

# (1) Kernel Smooth 분석

tt <- seq(2006.1, 2010.9, length=20)
 [1] 2006.100 2006.353 2006.605 2006.858 2007.111 2007.363 2007.616 2007.868 2008.121 2008.374
[11] 2008.626 2008.879 2009.132 2009.384 2009.637 2009.889 2010.142 2010.395 2010.647 2010.900

ks1 <- ksmooth(tt, dd3, "normal", bandwidth = 0.5)
ks2 <- ksmooth(tt, dd3, "normal", bandwidth = 1.5)
ks3 <- ksmooth(tt, dd3, "normal", bandwidth = 2.5)

ks1
$x # 왜 x가 이래 바뀌었지? ㅠ.ㅜ 왜 뻥튀기? ㅠ.ㅜ
  [1] 2006.100 2006.148 2006.197 2006.245 2006.294 2006.342 2006.391 2006.439 2006.488 2006.536 2006.585 2006.633 2006.682 2006.730
 [15] 2006.779 2006.827 2006.876 2006.924 2006.973 2007.021 2007.070 2007.118 2007.167 2007.215 2007.264 2007.312 2007.361 2007.409
 [29] 2007.458 2007.506 2007.555 2007.603 2007.652 2007.700 2007.748 2007.797 2007.845 2007.894 2007.942 2007.991 2008.039 2008.088
 [43] 2008.136 2008.185 2008.233 2008.282 2008.330 2008.379 2008.427 2008.476 2008.524 2008.573 2008.621 2008.670 2008.718 2008.767
 [57] 2008.815 2008.864 2008.912 2008.961 2009.009 2009.058 2009.106 2009.155 2009.203 2009.252 2009.300 2009.348 2009.397 2009.445
 [71] 2009.494 2009.542 2009.591 2009.639 2009.688 2009.736 2009.785 2009.833 2009.882 2009.930 2009.979 2010.027 2010.076 2010.124
 [85] 2010.173 2010.221 2010.270 2010.318 2010.367 2010.415 2010.464 2010.512 2010.561 2010.609 2010.658 2010.706 2010.755 2010.803
 [99] 2010.852 2010.900

$y
  [1] 1171.710 1180.408 1190.255 1200.813 1211.485 1221.706 1231.133 1239.746 1247.825 1255.800 1264.023 1272.612 1281.143 1288.888
 [15] 1294.932 1298.598 1299.905 1299.770 1300.153 1303.543 1312.281 1327.711 1349.564 1375.574 1402.171 1425.344 1441.945 1450.538
 [29] 1452.074 1449.243 1445.611 1444.402 1447.349 1454.297 1463.241 1471.128 1474.960 1472.857 1464.643 1451.983 1437.697 1424.867
 [43] 1415.870 1411.846 1412.411 1416.153 1421.190 1425.833 1428.994 1430.439 1430.566 1430.127 1429.839 1430.210 1431.198 1432.450
 [57] 1433.408 1433.593 1432.727 1431.066 1429.158 1427.741 1427.435 1428.483 1430.486 1432.528 1433.390 1432.018 1428.022 1422.100
 [71] 1415.959 1412.151 1413.288 1421.229 1436.471 1457.704 1482.315 1507.027 1528.874 1545.886 1557.509 1564.387 1567.916 1569.687
 [85] 1570.998 1572.668 1574.924 1577.533 1579.954 1581.506 1581.352 1578.744 1572.970 1563.566 1550.509 1534.367 1516.233 1497.532
 [99] 1479.666 1463.691

ks2$y
  [1] 1233.551 1237.450 1241.551 1245.813 1250.265 1254.911 1259.758 1264.822 1270.083 1275.552 1281.226 1287.102 1293.185 1299.443
 [15] 1305.870 1312.448 1319.154 1325.966 1332.845 1339.759 1346.671 1353.539 1360.328 1366.982 1373.461 1379.723 1385.727 1391.435
 [29] 1396.807 1401.822 1406.455 1410.688 1414.510 1417.933 1420.934 1423.535 1425.750 1427.600 1429.120 1430.322 1431.246 1431.925
 [43] 1432.392 1432.693 1432.845 1432.888 1432.870 1432.781 1432.682 1432.581 1432.509 1432.486 1432.542 1432.675 1432.914 1433.280
 [57] 1433.789 1434.466 1435.309 1436.349 1437.600 1439.081 1440.810 1442.791 1445.039 1447.564 1450.368 1453.463 1456.814 1460.426
 [71] 1464.280 1468.352 1472.605 1477.017 1481.537 1486.120 1490.719 1495.283 1499.767 1504.106 1508.261 1512.187 1515.842 1519.189
 [85] 1522.205 1524.862 1527.144 1529.041 1530.560 1531.678 1532.417 1532.789 1532.810 1532.505 1531.881 1530.971 1529.799 1528.388
 [99] 1526.775 1524.960

ks3$y
  [1] 1283.008 1286.082 1289.235 1292.429 1295.679 1298.984 1302.340 1305.758 1309.210 1312.706 1316.240 1319.808 1323.407 1327.045
 [15] 1330.691 1334.351 1338.021 1341.694 1345.375 1349.036 1352.682 1356.305 1359.898 1363.458 1366.973 1370.440 1373.852 1377.204
 [29] 1380.490 1383.705 1386.844 1389.905 1392.883 1395.777 1398.584 1401.303 1403.934 1406.477 1408.935 1411.307 1413.599 1415.812
 [43] 1417.952 1420.022 1422.029 1423.977 1425.874 1427.725 1429.537 1431.318 1433.074 1434.811 1436.537 1438.257 1439.978 1441.705
 [57] 1443.443 1445.196 1446.970 1448.766 1450.587 1452.435 1454.311 1456.215 1458.148 1460.107 1462.090 1464.096 1466.122 1468.163
 [71] 1470.216 1472.277 1474.340 1476.401 1478.453 1480.493 1482.514 1484.523 1486.488 1488.419 1490.310 1492.156 1493.964 1495.706
 [85] 1497.390 1499.013 1500.572 1502.074 1503.493 1504.839 1506.112 1507.308 1508.428 1509.478 1510.441 1511.326 1512.133 1512.862
 [99] 1513.531 1514.105

# (2) 분석결과 

plot(dd3, type="b", main="Kernel Smoothing by Bandwidth")
lines(ks1, col="red", lty=2, lwd=2) # bandwidth 값이 작을수록 그래프 시계열 자료에 근접하며 
lines(ks2, col="blue", lty=6, lwd=2)
lines(ks3, col="gray", lty=3, lwd=2) # bandwidth 값이 클수록 부드러워진다
legend("bottomright", 
	c("Kernel Smooth: bandwidth=0.5", "Kernel Smooth: bandwidth=1.5", "Kernel Smooth: bandwidth=2.5"), col=c("red", "blue", "gray"), lty=c(2, 6, 3), 
	cex=.8) # 숫자나 텍스트 확대 축소 비율 

# (3) 최적의 bandwidth 산정

library(KernSmooth)
( hh <- dpill(tt, dd3) )
[1] 0.7122351 # 최적값

kss <- locpoly(tt, dd3, bandwidth = hh) # optimal bandwidth 0.71을 이용한 추정은 locpoly 사용
#kss # $x 와 $y 값이 나옴 # x: 시간변수, y: 추정값
# $x
#   [1] 2006.100 2006.112 2006.124 2006.136 2006.148 2006.160 2006.172 2006.184 2006.196 2006.208 2006.220 2006.232 2006.244 2006.256
#  [15] 2006.268 2006.280 2006.292 2006.304 2006.316 2006.328 2006.340 2006.352 2006.364 2006.376 2006.388 2006.400 2006.412 2006.424
#  [29] 2006.436 2006.448 2006.460 2006.472 2006.484 2006.496 2006.508 2006.520 2006.532 2006.544 2006.556 2006.568 2006.580 2006.592
#  [43] 2006.604 2006.616 2006.628 2006.640 2006.652 2006.664 2006.676 2006.688 2006.700 2006.712 2006.724 2006.736 2006.748 2006.760
#  [57] 2006.772 2006.784 2006.796 2006.808 2006.820 2006.832 2006.844 2006.856 2006.868 2006.880 2006.892 2006.904 2006.916 2006.928
#  [71] 2006.940 2006.952 2006.964 2006.976 2006.988 2007.000 2007.012 2007.024 2007.036 2007.048 2007.060 2007.072 2007.084 2007.096
#  [85] 2007.108 2007.120 2007.132 2007.144 2007.156 2007.168 2007.180 2007.192 2007.204 2007.216 2007.228 2007.240 2007.252 2007.264
#  [99] 2007.276 2007.288 2007.300 2007.312 2007.324 2007.336 2007.348 2007.360 2007.372 2007.384 2007.396 2007.408 2007.420 2007.432
# [113] 2007.444 2007.456 2007.468 2007.480 2007.492 2007.504 2007.516 2007.528 2007.540 2007.552 2007.564 2007.576 2007.588 2007.600
# [127] 2007.612 2007.624 2007.636 2007.648 2007.660 2007.672 2007.684 2007.696 2007.708 2007.720 2007.732 2007.744 2007.756 2007.768
# [141] 2007.780 2007.792 2007.804 2007.816 2007.828 2007.840 2007.852 2007.864 2007.876 2007.888 2007.900 2007.912 2007.924 2007.936
# [155] 2007.948 2007.960 2007.972 2007.984 2007.996 2008.008 2008.020 2008.032 2008.044 2008.056 2008.068 2008.080 2008.092 2008.104
# [169] 2008.116 2008.128 2008.140 2008.152 2008.164 2008.176 2008.188 2008.200 2008.212 2008.224 2008.236 2008.248 2008.260 2008.272
# [183] 2008.284 2008.296 2008.308 2008.320 2008.332 2008.344 2008.356 2008.368 2008.380 2008.392 2008.404 2008.416 2008.428 2008.440
# [197] 2008.452 2008.464 2008.476 2008.488 2008.500 2008.512 2008.524 2008.536 2008.548 2008.560 2008.572 2008.584 2008.596 2008.608
# [211] 2008.620 2008.632 2008.644 2008.656 2008.668 2008.680 2008.692 2008.704 2008.716 2008.728 2008.740 2008.752 2008.764 2008.776
# [225] 2008.788 2008.800 2008.812 2008.824 2008.836 2008.848 2008.860 2008.872 2008.884 2008.896 2008.908 2008.920 2008.932 2008.944
# [239] 2008.956 2008.968 2008.980 2008.992 2009.004 2009.016 2009.028 2009.040 2009.052 2009.064 2009.076 2009.088 2009.100 2009.112
# [253] 2009.124 2009.136 2009.148 2009.160 2009.172 2009.184 2009.196 2009.208 2009.220 2009.232 2009.244 2009.256 2009.268 2009.280
# [267] 2009.292 2009.304 2009.316 2009.328 2009.340 2009.352 2009.364 2009.376 2009.388 2009.400 2009.412 2009.424 2009.436 2009.448
# [281] 2009.460 2009.472 2009.484 2009.496 2009.508 2009.520 2009.532 2009.544 2009.556 2009.568 2009.580 2009.592 2009.604 2009.616
# [295] 2009.628 2009.640 2009.652 2009.664 2009.676 2009.688 2009.700 2009.712 2009.724 2009.736 2009.748 2009.760 2009.772 2009.784
# [309] 2009.796 2009.808 2009.820 2009.832 2009.844 2009.856 2009.868 2009.880 2009.892 2009.904 2009.916 2009.928 2009.940 2009.952
# [323] 2009.964 2009.976 2009.988 2010.000 2010.012 2010.024 2010.036 2010.048 2010.060 2010.072 2010.084 2010.096 2010.108 2010.120
# [337] 2010.132 2010.144 2010.156 2010.168 2010.180 2010.192 2010.204 2010.216 2010.228 2010.240 2010.252 2010.264 2010.276 2010.288
# [351] 2010.300 2010.312 2010.324 2010.336 2010.348 2010.360 2010.372 2010.384 2010.396 2010.408 2010.420 2010.432 2010.444 2010.456
# [365] 2010.468 2010.480 2010.492 2010.504 2010.516 2010.528 2010.540 2010.552 2010.564 2010.576 2010.588 2010.600 2010.612 2010.624
# [379] 2010.636 2010.648 2010.660 2010.672 2010.684 2010.696 2010.708 2010.720 2010.732 2010.744 2010.756 2010.768 2010.780 2010.792
# [393] 2010.804 2010.816 2010.828 2010.840 2010.852 2010.864 2010.876 2010.888 2010.900

# $y
#   [1] 1164.991 1167.360 1169.724 1172.082 1174.435 1176.783 1179.125 1181.463 1183.795 1186.122 1188.444 1190.761 1193.072 1195.378
#  [15] 1197.680 1200.002 1202.335 1204.622 1206.904 1209.180 1211.452 1213.717 1215.978 1218.233 1220.483 1222.727 1224.965 1227.198
#  [29] 1229.425 1231.647 1233.862 1236.072 1238.276 1240.473 1242.665 1244.850 1247.036 1249.222 1251.388 1253.547 1255.699 1257.844
#  [43] 1259.982 1262.113 1264.236 1266.352 1268.461 1270.561 1272.654 1274.738 1276.814 1278.882 1280.941 1282.992 1285.034 1287.067
#  [57] 1289.090 1291.106 1293.116 1295.110 1297.094 1299.069 1301.032 1302.986 1304.928 1306.860 1308.781 1310.691 1312.589 1314.475
#  [71] 1316.350 1318.213 1320.063 1321.902 1323.727 1325.540 1327.340 1329.127 1330.901 1332.659 1334.406 1336.138 1337.857 1339.562
#  [85] 1341.252 1342.927 1344.588 1346.235 1347.866 1349.482 1351.083 1352.668 1354.238 1355.792 1357.330 1358.852 1360.358 1361.848
#  [99] 1363.321 1364.778 1366.214 1367.637 1369.044 1370.433 1371.806 1373.161 1374.499 1375.820 1377.124 1378.410 1379.679 1380.930
# [113] 1382.164 1383.380 1384.578 1385.759 1386.922 1388.068 1389.195 1390.305 1391.397 1392.470 1393.527 1394.566 1395.588 1396.592
# [127] 1397.578 1398.547 1399.499 1400.433 1401.350 1402.249 1403.132 1403.997 1404.846 1405.677 1406.492 1407.291 1408.072 1408.838
# [141] 1409.587 1410.320 1411.038 1411.740 1412.426 1413.096 1413.752 1414.392 1415.017 1415.628 1416.224 1416.806 1417.374 1417.928
# [155] 1418.468 1418.995 1419.509 1420.010 1420.498 1420.974 1421.437 1421.889 1422.329 1422.757 1423.174 1423.581 1423.976 1424.362
# [169] 1424.737 1425.102 1425.459 1425.805 1426.143 1426.473 1426.794 1427.107 1427.412 1427.710 1428.001 1428.285 1428.563 1428.834
# [183] 1429.100 1429.360 1429.615 1429.865 1430.110 1430.351 1430.588 1430.822 1431.052 1431.279 1431.503 1431.726 1431.946 1432.164
# [197] 1432.381 1432.597 1432.811 1433.026 1433.240 1433.455 1433.669 1433.885 1434.102 1434.320 1434.539 1434.761 1434.985 1435.211
# [211] 1435.440 1435.672 1435.908 1436.147 1436.390 1436.638 1436.890 1437.147 1437.409 1437.676 1437.949 1438.227 1438.512 1438.803
# [225] 1439.101 1439.405 1439.717 1440.036 1440.362 1440.697 1441.039 1441.390 1441.749 1442.117 1442.494 1442.879 1443.275 1443.679
# [239] 1444.103 1444.527 1444.960 1445.405 1445.860 1446.325 1446.802 1447.289 1447.788 1448.298 1448.819 1449.353 1449.898 1450.455
# [253] 1451.024 1451.605 1452.199 1452.806 1453.424 1454.056 1454.700 1455.360 1456.030 1456.714 1457.410 1458.120 1458.844 1459.580
# [267] 1460.331 1461.095 1461.872 1462.664 1463.469 1464.288 1465.121 1465.968 1466.828 1467.703 1468.592 1469.494 1470.411 1471.342
# [281] 1472.286 1473.245 1474.217 1475.204 1476.204 1477.219 1478.247 1479.289 1480.345 1481.414 1482.497 1483.594 1484.704 1485.828
# [295] 1486.965 1488.116 1489.279 1490.456 1491.646 1492.848 1494.063 1495.290 1496.530 1497.783 1499.049 1500.326 1501.615 1502.916
# [309] 1504.229 1505.553 1506.889 1508.236 1509.593 1510.962 1512.341 1513.730 1515.130 1516.539 1517.959 1519.387 1520.826 1522.273
# [323] 1523.730 1525.195 1526.669 1528.150 1529.640 1531.138 1532.643 1534.155 1535.674 1537.200 1538.733 1540.271 1541.816 1543.366
# [337] 1544.922 1546.483 1548.049 1549.619 1551.194 1552.773 1554.356 1555.964 1557.561 1559.153 1560.748 1562.344 1563.943 1565.544
# [351] 1567.146 1568.750 1570.354 1571.959 1573.564 1575.170 1576.775 1578.380 1579.984 1581.587 1583.188 1584.788 1586.386 1587.982
# [365] 1589.595 1591.195 1592.783 1594.367 1595.947 1597.524 1599.097 1600.666 1602.230 1603.790 1605.344 1606.894 1608.437 1609.976
# [379] 1611.508 1613.034 1614.554 1616.067 1617.573 1619.073 1620.565 1622.146 1623.679 1625.145 1626.603 1628.052 1629.493 1630.926
# [393] 1632.350 1633.766 1635.172 1636.569 1637.957 1639.336 1640.705 1642.064 1643.414

plot(dd3, type="b", main="Kernel Smoothing by Optimal Bandwidth")
lines(kss, col="red", lty=2, lwd=2)
legend("bottomright", c("Survey data", "Kernel Smooth \n bandwidth=0.712"), col=c("black", "red"), lty=c(1, 2), cex=.8)

# 5) (Kernel Smooth) 평활법 분석사례: kernel function (Daniell)

# (1) Kernel Smooth 분석

tt <- seq(1, 20)
( kk1 <- kernel("daniell", 1) )
Daniell(1) 
coef[-1] = 0.3333
coef[ 0] = 0.3333
coef[ 1] = 0.3333

( kk2 <- kernel("daniell", 2) )
Daniell(2) 
coef[-2] = 0.2
coef[-1] = 0.2
coef[ 0] = 0.2
coef[ 1] = 0.2
coef[ 2] = 0.2

( kk3 <- kernel("daniell", 3) )
Daniell(3) 
coef[-3] = 0.1429
coef[-2] = 0.1429
coef[-1] = 0.1429
coef[ 0] = 0.1429
coef[ 1] = 0.1429
coef[ 2] = 0.1429
coef[ 3] = 0.1429

xx1 <- kernapply(dd3, kk1)
         Qtr1     Qtr2     Qtr3     Qtr4
2006                   1212.000 1279.000
2007 1273.333 1376.667 1381.000 1496.667
2008 1423.667 1458.000 1404.667 1441.333
2009 1422.000 1444.000 1400.333 1468.667
2010 1494.000 1583.000 1580.000 1531.333

xx2 <- kernapply(dd3, kk2)
       Qtr1   Qtr2   Qtr3   Qtr4
2007 1240.8 1324.8 1347.6 1411.6
2008 1411.6 1458.4 1428.4 1447.8
2009 1413.6 1440.6 1413.2 1452.0
2010 1472.2 1509.8 1533.6 1550.8

xx3 <- kernapply(dd3, kk3)
         Qtr1     Qtr2     Qtr3     Qtr4
2007                   1303.143 1364.571
2008 1379.000 1408.571 1418.429 1451.000
2009 1428.000 1445.429 1409.714 1447.286
2010 1460.857 1486.143 1506.714 1507.714


# (2) 분석결과 

plot(tt, dd3, type="b", main="Kernel Smoothing by Daniell Fucntion")
#lines(xx1, col="blue", lty=2, lwd=2) # xx1이 시계열 자료라서 이렇게 쓰면 안나옴
lines(data.frame(xx1), col="blue", lty=2, lwd=2) # data.frame 이나
lines(matrix(xx2), col="red", lty=3, lwd=2) # matrix 로 변환
lines(data.frame(xx3), col="gray", lty=4, lwd=2)
legend("bottomright", c("kernel-daniel-1", "kernel-daniel-2", "kernel-daniel-3"), col=c("blue", "red", "gray"), lty=c(2, 3, 4), lwd=c(2,2,2))

# - Daniell Function에 의한 Kernel Smoothing 분석 결과는 Kernel Dimension 값에 따라 추정값이 크게 변하게 된다
# - Dimension 값이 작을수록 자료에 근접하며, 클수록 부드러워짐 
# - Dimension < 시계열 자료수

> kk20<-kernel("daniell", 20)
> kernapply(dd3, kk20)
Error in kernapply.vector(x, k, circular = circular) : 
  'x' is shorter than kernel 'k'

# R에서의 Kernel Function은 Daniell, Dirichlet, Fejer, modified.daniell 등으로 구분된다. (default는 Daniell)

# 6) (Lowess Smooth) 평활법 분석사례: lowess

# (1) Lowess 분석

( la1 <- lowess(dd3) )
$x
 [1] 2006.00 2006.25 2006.50 2006.75 2007.00 2007.25 2007.50 2007.75 2008.00 2008.25
[11] 2008.50 2008.75 2009.00 2009.25 2009.50 2009.75 2010.00 2010.25 2010.50 2010.75

$y
 [1] 1188.362 1217.717 1246.618 1275.243 1303.638 1331.369 1356.587 1376.761 1396.129
[10] 1413.125 1423.637 1436.783 1456.238 1478.766 1500.389 1518.193 1536.189 1554.740
[19] 1573.470 1591.747

( la2 <- lowess(dd3, f=.2) )
$x
 [1] 2006.00 2006.25 2006.50 2006.75 2007.00 2007.25 2007.50 2007.75 2008.00 2008.25
[11] 2008.50 2008.75 2009.00 2009.25 2009.50 2009.75 2010.00 2010.25 2010.50 2010.75

$y
 [1] 1152.676 1216.147 1274.887 1287.070 1346.124 1371.987 1454.108 1433.108 1439.652
[10] 1413.880 1437.016 1426.443 1437.596 1417.231 1466.246 1513.092 1577.883 1581.412
[19] 1538.947 1430.868

# (2) 분석결과 

plot(dd3, type="b", xlab="Time", main="Locally Weighted Polynomial Regression Smoothing")
lines(lowess(dd3), col="red", lty=2, lwd=2)
lines(lowess(dd3, f=.2), col="blue", lty=6, lwd=2)
legend("bottomright", c("LOWESS -- f=2/3", "LOWESS -- f=0.2"), col=c("red", "blue"), lty=c(2, 6), lwd=c(2,2))

# - Lowess Smoothing 분석 결과는 평활화 상수 f 값에 따라 추정값이 크게 변하게 된다
# - 아무 지정 없는 default 값이 2/3이면, 시계열 자료는 부드러워지며, f값이 이보다 작은 f=.2 이면 자료에 근접하며 큰 진동을 보이는 것으로 나타남
# - 평활 상수의 값은 연구목적에 따라 선택적으로 설정

# 7) (Loess Smooth) 평활법 분석사례: loess

# (1) Loess 분석

> tt <- seq(1, 20)
> ( lb1 <- loess(dd3 ~ tt) ) # 디폴트값 span=0.75, 작은진동

Call:
loess(formula = dd3 ~ tt)

Number of Observations: 20 
Equivalent Number of Parameters: 4.44 
Residual Standard Error: 99.42 

> names(lb1)
 [1] "n"         "fitted"    "residuals" "enp"       "s"         "one.delta"
 [7] "two.delta" "trace.hat" "divisor"   "robust"    "pars"      "kd"       
[13] "call"      "terms"     "xnames"    "x"         "y"         "weights" 

> lb1$fitted
 [1] 1143.646 1213.004 1273.684 1325.494 1368.429 1403.039 1429.354 1446.803 1447.620
[10] 1441.816 1433.449 1420.849 1421.515 1449.569 1478.455 1493.928 1508.493 1518.750
[19] 1523.085 1523.113


> ( lb2 <- loess(dd3 ~ tt, span=.35) ) 

Call:
loess(formula = dd3 ~ tt, span = 0.35)

Number of Observations: 20 
Equivalent Number of Parameters: 9.79 
Residual Standard Error: 127.6 # 큰 진동인데 Residual이 더 크다


# (2) 분석결과 

plot(tt, dd3, t="b", xlab="Time", main="Local Polynomial Regression Smoothing")
lines(tt, lb1$fitted, col="red", lty=2, lwd=2)  # span=.75, #기본값 # 부드러움
lines(tt, lb2$fitted, col="blue", lty=6, lwd=2) # span=.35 #자료에 근접, 큰 진동 
legend("bottomright", c("LOESS: span=0.75", "LOESS: span=0.35"), col=c("red", "blue"), lty=c(2, 6), lwd=c(2,2), cex=.8)


# 8) (Spline Smooth) 평활법 분석사례: smooth.spline

# (1) Spline Smooth 분석

tt <- seq(1:20)
( sa1 <- smooth.spline(x=tt, y=dd3) ) # 자동 최적 
Call:
smooth.spline(x = tt, y = dd3)

Smoothing Parameter  spar= 0.7649793  lambda= 0.03408847 (12 iterations)
Equivalent Degrees of Freedom (Df): 2.804372 # 자동최적 df=2.8, 작은 진동
Penalized Criterion (RSS): 172040.6
GCV: 11636.57

> names(sa1)
 [1] "x"          "y"          "w"          "yin"        "tol"        "data"      
 [7] "no.weights" "lev"        "cv.crit"    "pen.crit"   "crit"       "df"        
[13] "spar"       "ratio"      "lambda"     "iparms"     "auxM"       "fit"       
[19] "call"      

> sa1$fit
$knot
 [1] 0.00000000 0.00000000 0.00000000 0.00000000 0.05263158 0.10526316 0.15789474
 [8] 0.21052632 0.26315789 0.31578947 0.36842105 0.42105263 0.47368421 0.52631579
[15] 0.57894737 0.63157895 0.68421053 0.73684211 0.78947368 0.84210526 0.89473684
[22] 0.94736842 1.00000000 1.00000000 1.00000000 1.00000000

$nk
[1] 22

$min
[1] 1

$range
[1] 19

$coef
 [1] 1225.077 1234.439 1253.162 1280.892 1307.864 1333.552 1357.582 1379.114 1398.189
[10] 1414.747 1429.475 1442.753 1455.089 1466.862 1478.439 1489.909 1501.355 1512.147
[19] 1522.098 1531.204 1536.899 1539.746

attr(,"class")
[1] "smooth.spline.fit"

# (2) 분석결과

plot(tt, dd3, type="b", main="Smoothing Spline: dd3")
( sa2 <- smooth.spline(x=tt, y=dd3, df=10) )
Call:
smooth.spline(x = tt, y = dd3, df = 10) # df=10 지정, 큰 진동

Smoothing Parameter  spar= 0.3732505  lambda= 5.040541e-05 (12 iterations)
Equivalent Degrees of Freedom (Df): 9.998838
Penalized Criterion (RSS): 91925.24
GCV: 18380.78

lines(sa1, col="blue", lty=2, lwd=2)
lines(sa2, col="red", lty=6, lwd=2)
legend("bottomright", c(paste("default[CV]->df=", round(sa1$df, 1)), "Spline [CV]->df=10"), 
  col=c("blue", "red"), lty=c(2, 6))


# 9) (Friedman Super Smoother) 평활법 분석사례: supsmu

# (1) Super Smoother 분석

(su1 <- supsmu(tt, dd3)) # default는 span=CV, bass=0 
$x 
 [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20

$y
 [1] 1214.053 1244.039 1274.024 1308.783 1341.888 1379.313 1403.607 1426.493 1431.399
[10] 1437.760 1428.720 1433.440 1438.320 1457.560 1476.160 1503.680 1516.380 1517.980
[19] 1510.250 1502.520

(su2 <- supsmu(x=tt, y=dd3, bass=10))
$x
 [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20

$y
 [1] 1215.273 1243.273 1271.273 1299.273 1327.327 1352.673 1376.527 1394.400 1413.600
[10] 1427.000 1441.745 1452.836 1465.491 1473.631 1484.329 1493.204 1504.036 1516.100
[19] 1528.164 1540.227

# (2) 분석결과 

plot(tt, dd3, type="b", main="Friedman Super Smoother: dd3")
lines(su1, col=4, lty=2, lwd=2) # bass=0  #최소값 # 큰 진동 
lines(su2, col=2, lty=6, lwd=2) # bass=10 #최대값 # 작은진동
legend("bottomright", c("default smoother: bass=0", "Super Smoother: bass=10"),
  col=c(4, 2), lty=c(2, 6))

# Super Smoother 법은 이동직선 평활법의 함수로서, 직선을 3개 구간으로 구분하여 
# 그중에서 가장 우수한 평활 결과를 토대로 이동직선 평활법이 산정된다.
# 만약 span의 값을 지정하면 span*n의 평활법이 산정된다

# 표본이 작고 계열상관이 있는 경우, span=0.2~0.4의 값으로 분석한다

# 10) (Scatter Plot Smoother) 평활법 분석사례: scatter.smooth

plot(tt, dd3, type="b", main="Scatter Smooth (Loess): dd3")
par(new=T)
scatter.smooth(tt, dd3, lpars=list(col="red", lty=2, lwd=2))
legend("bottomright", c("Survey Data", "Scatter Smooth"), col=c(1, 2), lty=c(1, 2))

# scatter.smooth는 시계열 자료의 lowess(Locally Weighted Polynomial Regression)의 디폴트값인 
# span=2/3, degree=1이 적용된다
# span: smoothness parameter for loess
# degree: degree of local polynomial used

# 그래프의 선형을 변형하고자 하면 span, degree 값을 변경한다
# span값을 작게, degree값을 크게 하면 자료에 보다 적합한 큰 진동을 얻는다

scatter.smooth(tt, dd3, degree=10, lpars=list(col=4, lty=2, lwd=2))
scatter.smooth(tt, dd3, span=0.2, degree=10, lpars=list(col=6, lty=2, lwd=2))
