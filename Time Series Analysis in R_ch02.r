
# 2.1 시계열 자료의 이해 

# 2) 시계열 자료의 속성: class, start, end, frequency, cycle, tsp

## 차분 (Difference), diff

dd <- matrix( c(1342, 1442, 1252, 1343, 	1425, 1362, 1256, 1272, 
	1243, 1359, 1412, 1253,					1201, 1478, 1322, 1406,
	1254, 1289, 1497, 1208))

dd.ts <- ts(data=dd, start=c(2006, 1), frequency=4)

> dd.ts

Qtr1 Qtr2 Qtr3 Qtr4
2006 1342 1442 1252 1343
2007 1425 1362 1256 1272
2008 1243 1359 1412 1253
2009 1201 1478 1322 1406
2010 1254 1289 1497 1208

> diff(dd.ts)

Qtr1 Qtr2 Qtr3 Qtr4
2006       100 -190   91
2007   82  -63 -106   16
2008  -29  116   53 -159
2009  -52  277 -156   84
2010 -152   35  208 -289

> diff(dd.ts, 2)

Qtr1 Qtr2 Qtr3 Qtr4
2006            -90  -99
2007  173   19 -169  -90
2008  -13   87  169 -106
2009 -211  225  121  -72
2010  -68 -117  243  -81

> diff(dd.ts, 1, 2)

Qtr1 Qtr2 Qtr3 Qtr4
2006           -290  281
2007   -9 -145  -43  122
2008  -45  145  -63 -212
2009  107  329 -433  240
2010 -236  187  173 -497

> diff(diff(dd.ts))

Qtr1 Qtr2 Qtr3 Qtr4
2006           -290  281
2007   -9 -145  -43  122
2008  -45  145  -63 -212
2009  107  329 -433  240
2010 -236  187  173 -497


> cycle(dd.ts)
     Qtr1 Qtr2 Qtr3 Qtr4
2006    1    2    3    4
2007    1    2    3    4
2008    1    2    3    4
2009    1    2    3    4
2010    1    2    3    4


> cycle(lag(dd.ts, k=2))
     Qtr1 Qtr2 Qtr3 Qtr4
2005              3    4
2006    1    2    3    4
2007    1    2    3    4
2008    1    2    3    4
2009    1    2    3    4
2010    1    2 


## 역차분 (Inverse Difference), diffinv

> ( d1 <- diff(dd.ts) )

Qtr1 Qtr2 Qtr3 Qtr4
2006       100 -190   91
2007   82  -63 -106   16
2008  -29  116   53 -159
2009  -52  277 -156   84
2010 -152   35  208 -289

> ( d2 <- diffinv (d1))

Qtr1 Qtr2 Qtr3 Qtr4
2006    0  100  -90    1
2007   83   20  -86  -70
2008  -99   17   70  -89
2009 -141  136  -20   64
2010  -88  -53  155 -134

> for (i in 1:length(dd.ts)) d3 <- d2 + 1142 ## 초기값 1142를 고려, 원래 조사자료로 환원

> d3
     Qtr1 Qtr2 Qtr3 Qtr4
2006 1142 1242 1052 1143
2007 1225 1162 1056 1072
2008 1043 1159 1212 1053
2009 1001 1278 1122 1206
2010 1054 1089 1297 1008


## 8) 시계열 자료의 합집합 ts.union

> zz1 <- ts(matrix(1:24, 8, 3), s=c(2001, 1), f=4, n=c("a", "b", "c"))

> zz1 
        a  b  c
2001 Q1 1  9 17
2001 Q2 2 10 18
2001 Q3 3 11 19
2001 Q4 4 12 20
2002 Q1 5 13 21
2002 Q2 6 14 22
2002 Q3 7 15 23
2002 Q4 8 16 24

> zz2 <- ts(matrix(11:22, 4, 3), s=c(2002, 1), f=4, n=c("a", "b", "c"))

> zz2
         a  b  c
2002 Q1 11 15 19
2002 Q2 12 16 20
2002 Q3 13 17 21
2002 Q4 14 18 22

> union (zz1, zz2) ## 일반적 합집합
 [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17
[18] 18 19 20 21 22 23 24

> ts.union (zz1, zz2) ## 시계열 합집합 ## 결측값은 NA

        zz1.a zz1.b zz1.c zz2.a zz2.b zz2.c
2001 Q1     1     9    17    NA    NA    NA
2001 Q2     2    10    18    NA    NA    NA
2001 Q3     3    11    19    NA    NA    NA
2001 Q4     4    12    20    NA    NA    NA
2002 Q1     5    13    21    11    15    19
2002 Q2     6    14    22    12    16    20
2002 Q3     7    15    23    13    17    21
2002 Q4     8    16    24    14    18    22

## 9) 시계열 자료의 교집합 ts.intersect

> intersect(zz1, zz2) ## 일반적 교집합
 [1] 11 12 13 14 15 16 17 18 19 20 21 22

> ts.intersect(zz1, zz2) ## 시계열 교집합
        zz1.a zz1.b zz1.c zz2.a zz2.b zz2.c
2002 Q1     5    13    21    11    15    19
2002 Q2     6    14    22    12    16    20
2002 Q3     7    15    23    13    17    21
2002 Q4     8    16    24    14    18    22

> zz3 <-ts(matrix(21:32, 4, 3), s=c(2003, 1), f=4, n=c("a", "b", "c"))

> ts.intersect(zz2, zz3) ## 교집합 결과 없음
NULL
Warning message:
In .cbind.ts(list(...), .makeNamesTs(...), dframe = dframe, union = FALSE) :
  non-intersecting series


## 10) 시계열 자료의 부분추출 및 수정: window

> zz1 
        a  b  c
2001 Q1 1  9 17
2001 Q2 2 10 18
2001 Q3 3 11 19
2001 Q4 4 12 20
2002 Q1 5 13 21
2002 Q2 6 14 22
2002 Q3 7 15 23
2002 Q4 8 16 24

> window(zz1, s=c(2001, 3), delta=1) ## 3분기 자료만 추출 

Time Series:
Start = 2001.5 ## 분기를 표현하는 방법을 소수점으로
End = 2002.5 ## 1분기 따로 표시 없음, 2분기 .25, 3분기 .5, 4분기 .75
Frequency = 1 
       a  b  c
2001.5 3 11 19
2002.5 7 15 23

> window(zz1, c(2001, 3), c(2002, 2)) ## 2001-3분기 부터 2002-2분기 까지 부분 추출

        a  b  c
2001 Q3 3 11 19
2001 Q4 4 12 20
2002 Q1 5 13 21
2002 Q2 6 14 22

> window(zz1, c(2001, 1), c(2001, 2)) <- c(11, 22) ## 2001-1분기 부터 2001-2분기 까지 부분추출 <- 자료 수정

> zz1
         a  b  c
2001 Q1 11 11 11
2001 Q2 22 22 22
2001 Q3  3 11 19
2001 Q4  4 12 20
2002 Q1  5 13 21
2002 Q2  6 14 22
2002 Q3  7 15 23
2002 Q4  8 16 24


## 11) 자료의 통합 aggregate

> zz1
        a  b  c
2001 Q1 1  9 17
2001 Q2 2 10 18
2001 Q3 3 11 19
2001 Q4 4 12 20
2002 Q1 5 13 21
2002 Q2 6 14 22
2002 Q3 7 15 23
2002 Q4 8 16 24

> aggregate(zz1) ## f=4 를 f=1 로 aggregate
Time Series:
Start = 2001 
End = 2002 
Frequency = 1 	## 연도별 자료가 됨 !!!
      a  b  c
2001 10 42 74
2002 26 58 90

> aggregate(zz1, nf = 2, FUN = mean) ## f=4를 f=2 로 aggregate
Time Series:
Start = c(2001, 1) 
End = c(2002, 2) 
Frequency = 2 	## 반기별 자료가 됨 !!
         a    b    c
2001.0 1.5  9.5 17.5 	## 상하반기 평균 !!
2001.5 3.5 11.5 19.5
2002.0 5.5 13.5 21.5
2002.5 7.5 15.5 23.5

> ff.ts <- rwf(dd.ts)

> ff.ts
        Point Forecast     Lo 80    Hi 80    Lo 95    Hi 95
2011 Q1           1208 1026.5486 1389.451 930.4941 1485.506
2011 Q2           1208  951.3890 1464.611 815.5474 1600.453
2011 Q3           1208  893.7170 1522.283 727.3457 1688.654
2011 Q4           1208  845.0973 1570.903 652.9882 1763.012
2012 Q1           1208  802.2624 1613.738 587.4780 1828.522
2012 Q2           1208  763.5368 1652.463 528.2522 1887.748
2012 Q3           1208  727.9248 1688.075 473.7884 1942.212
2012 Q4           1208  694.7781 1721.222 423.0948 1992.905
2013 Q1           1208  663.6459 1752.354 375.4823 2040.518
2013 Q2           1208  634.2004 1781.800 330.4493 2085.551

> accuracy(ff.ts) # 예측결과의 지표
                    ME     RMSE      MAE       MPE     MAPE     MASE       ACF1
Training set -7.052632 141.5872 118.8421 -1.110558 8.935594 1.175927 -0.4425693

> qq1 <- matrix(dd.ts) # 입력한 값 매트릭스 변환
> qq1
      [,1]
 [1,] 1342
 [2,] 1442
 [3,] 1252
 [4,] 1343
 [5,] 1425
 [6,] 1362
 [7,] 1256
 [8,] 1272
 [9,] 1243
[10,] 1359
[11,] 1412
[12,] 1253
[13,] 1201
[14,] 1478
[15,] 1322
[16,] 1406
[17,] 1254
[18,] 1289
[19,] 1497
[20,] 1208

> ff.ts$fitted  # 예측결과 why 2006 ????
     Qtr1 Qtr2 Qtr3 Qtr4
2006   NA 1342 1442 1252
2007 1343 1425 1362 1256
2008 1272 1243 1359 1412
2009 1253 1201 1478 1322
2010 1406 1254 1289 1497

> qq2 <- matrix(ff.ts$fitted) # 예측결과 매트릭스 변환
> qq2
      [,1]
 [1,]   NA
 [2,] 1342
 [3,] 1442
 [4,] 1252
 [5,] 1343
 [6,] 1425
 [7,] 1362
 [8,] 1256
 [9,] 1272
[10,] 1243
[11,] 1359
[12,] 1412
[13,] 1253
[14,] 1201
[15,] 1478
[16,] 1322
[17,] 1406
[18,] 1254
[19,] 1289
[20,] 1497

> ff.ts$residuals # 예측오차? why 2006 ????
     Qtr1 Qtr2 Qtr3 Qtr4
2006   NA  100 -190   91
2007   82  -63 -106   16
2008  -29  116   53 -159
2009  -52  277 -156   84
2010 -152   35  208 -289


> ts(ff.ts$residuals, s=c(2011, 1), f=4) # 이렇게 하는 건가?
     Qtr1 Qtr2 Qtr3 Qtr4
2011   NA  100 -190   91
2012   82  -63 -106   16
2013  -29  116   53 -159
2014  -52  277 -156   84
2015 -152   35  208 -289

> qq3 <- matrix(ff.ts$residuals) # 예측오차 를 매트릭스 변환
> qq3
      [,1]
 [1,]   NA
 [2,]  100
 [3,] -190
 [4,]   91
 [5,]   82
 [6,]  -63
 [7,] -106
 [8,]   16
 [9,]  -29
[10,]  116
[11,]   53
[12,] -159
[13,]  -52
[14,]  277
[15,] -156
[16,]   84
[17,] -152
[18,]   35
[19,]  208
[20,] -289

> qq1 <- qq1[-1, ] # 첫번째값 제외
> qq1
 [1] 1442 1252 1343 1425 1362 1256 1272 1243 1359 1412
[11] 1253 1201 1478 1322 1406 1254 1289 1497 1208


> qq2 <- qq2[-1, ]  # 첫번째값 제외
> qq2
 [1] 1342 1442 1252 1343 1425 1362 1256 1272 1243 1359 1412 1253
[13] 1201 1478 1322 1406 1254 1289 1497


> qq3 <- qq3[-1, ]  # 첫번째값 제외
> qq3
 [1]  100 -190   91   82  -63 -106   16  -29  116   53 -159  -52
[13]  277 -156   84 -152   35  208 -289

> mean(qq3) # ME mean error
[1] -7.052632
> sqrt(mean(qq3^2)) # RSME root squared of mean error 
[1] 141.5872
> mean(abs(qq3)) # MAE mean absolute error
[1] 118.8421
> mean(qq3/qq1*100) # MPE mean percentage error
[1] -1.110558
> mean(abs(qq3/qq1*100)) # MAPE mean absolute percentage error 
[1] 8.935594


